# é­é‡ç³»ç»Ÿä½¿ç”¨æŒ‡å—

## æ¦‚è¿°

é­é‡ç³»ç»Ÿæ˜¯Can't Stopæ¸¸æˆä¸­çš„æ ¸å¿ƒç©æ³•ä¹‹ä¸€ï¼Œä¸ºç©å®¶æä¾›ä¸°å¯Œçš„äº¤äº’å¼äº‹ä»¶å’Œéšæœºé­é‡ã€‚ç©å®¶åœ¨ç§»åŠ¨æ£‹å­æ—¶å¯èƒ½è§¦å‘å„ç§é­é‡ï¼Œéœ€è¦åšå‡ºé€‰æ‹©å¹¶æ‰¿å—ç›¸åº”çš„åæœã€‚

## ç³»ç»Ÿæ¶æ„

### æ ¸å¿ƒç»„ä»¶

1. **é­é‡ç®¡ç†å™¨** (`src/core/encounter_system.py`)
   - ç®¡ç†é­é‡çš„è§¦å‘å’Œç©å®¶é€‰æ‹©
   - å¤„ç†follow_upæœºåˆ¶
   - è¿½è¸ªé­é‡å†å²

2. **æ•ˆæœå¤„ç†å™¨** (`src/core/effect_handler.py`)
   - å¤„ç†30+ç§æ¸¸æˆæ•ˆæœ
   - ç®¡ç†Buffå’Œå»¶è¿Ÿæ•ˆæœ
   - æ”¯æŒéª°å­ä¿®æ”¹ã€ç§¯åˆ†å˜åŒ–ã€é“å…·å¥–åŠ±ç­‰

3. **é“å…·ç³»ç»Ÿ** (`src/core/item_system.py`)
   - Buffç®¡ç†å™¨
   - é“å…·æ•ˆæœæ‰§è¡Œå™¨

4. **é­é‡é…ç½®** (`config/encounters.json`)
   - å®šä¹‰æ‰€æœ‰é­é‡äº‹ä»¶
   - é…ç½®é€‰é¡¹å’Œæ•ˆæœ

## æ•°æ®åº“è®¾ç½®

### è¿è¡Œè¿ç§»

é¦–æ¬¡ä½¿ç”¨é­é‡ç³»ç»Ÿå‰ï¼Œéœ€è¦è¿è¡Œæ•°æ®åº“è¿ç§»ï¼š

```bash
# Windows
set PYTHONIOENCODING=utf-8
cd migrations
python run_migration.py

# æˆ–ä½¿ç”¨è‡ªå®šä¹‰æ•°æ®åº“è·¯å¾„
python run_migration.py path/to/your/database.db
```

### æ–°å¢çš„æ•°æ®åº“è¡¨

1. **player_encounter_states** - ç©å®¶é­é‡çŠ¶æ€
2. **player_effects** - ç©å®¶æ•ˆæœï¼ˆBuffå’Œå»¶è¿Ÿæ•ˆæœï¼‰
3. **encounter_history** - é­é‡å†å²è®°å½•

## é­é‡ç±»å‹

### 1. ç®€å•é€‰æ‹©å‹é­é‡

ç©å®¶é€‰æ‹©ä¸€ä¸ªé€‰é¡¹ï¼Œç«‹å³è·å¾—æ•ˆæœã€‚

**ç¤ºä¾‹ï¼šå¤§æ’’å¸**
```
ä½ çœ‹è§è´¢æ”¿éƒ¨éƒ¨é•¿ä¸å¡”èŒœåœ¨è¿œå¤„...æ— æ•°çš„å°é’±é’±ä»å¤©è€Œé™...

é€‰é¡¹ï¼š
1. å°é’±é’±ï¼èµ¶å¿«æ¡é’±ï¼ â†’ è·å¾—10ç§¯åˆ†
2. å…ˆä¸ç®¡é’±äº†ï¼é è¿‘ä¸å¡”èŒœï¼ â†’ å¬åˆ°é­”æ€§æ­Œå£°ï¼Œè·å¾—10ç§¯åˆ†
```

### 2. éª°å­åˆ¤å®šå‹é­é‡

éœ€è¦æŠ•æ·éª°å­æ¥å†³å®šç»“æœã€‚

**ç¤ºä¾‹ï¼šå¤©ä¸‹æ— ç¨‹åºå‘˜**
```
ä½ çœ‹åˆ°ä¸€ä¸ªæ­£åœ¨ç–¯ç‹‚æ•²ä»£ç çš„äºº...

é€‰é¡¹ï¼šå¸®ä»–debug
- æŠ•æ·1d20
- å¤§äº10ï¼šæˆåŠŸï¼è·å¾—20ç§¯åˆ†
- å°äºç­‰äº10ï¼šå¤±è´¥ï¼å¤±å»10ç§¯åˆ†
```

### 3. é“å…·å¥–åŠ±å‹é­é‡

å®Œæˆåè·å¾—é“å…·ã€‚

**ç¤ºä¾‹ï¼šæ¢¦**
```
é€‰é¡¹ï¼šç›´æ¥è¿‡å»
- è·å¾—é“å…·ï¼šåæ‚”åˆ¸
- Follow-upï¼š60ç§’å†…å›å¤"è°¢è°¢è´¢ç¥"å¯è·å¾—é¢å¤–é“å…·
```

### 4. Buffæ•ˆæœå‹é­é‡

è·å¾—æŒç»­å¤šå›åˆçš„å¢ç›Šæˆ–å‡ç›Šã€‚

**ç¤ºä¾‹ï¼šé­”å¥³çš„è—ä¹¦å®¤**
```
é€‰é¡¹ï¼šå€Ÿä¹¦ï¼ˆæ¶ˆè€—5ç§¯åˆ†ï¼‰
- æ•ˆæœï¼šæ¥ä¸‹æ¥3å›åˆå¯é‡æŠ•éª°å­ï¼ˆæ¯å›åˆé™1æ¬¡ï¼‰
```

### 5. å»¶è¿Ÿæ•ˆæœå‹é­é‡

æ•ˆæœåœ¨æœªæ¥å›åˆè§¦å‘ã€‚

**ç¤ºä¾‹ï¼šå–µ**
```
é€‰é¡¹ï¼šå“æ­»æˆ‘äº†
- æ•ˆæœï¼šä¸‹ä¸€æ¬¡æŠ•æ·åªæŠ•5ä¸ªéª°å­
```

## æ•ˆæœç±»å‹è¯¦è§£

### ç§¯åˆ†ç›¸å…³

- **score_change**: ç›´æ¥æ”¹å˜ç§¯åˆ†
  ```json
  {
    "type": "score_change",
    "value": 10
  }
  ```

### éª°å­ç›¸å…³

- **dice_count_change**: æ”¹å˜éª°å­æ•°é‡
  ```json
  {
    "type": "dice_count_change",
    "value": 7,
    "duration": 1
  }
  ```

- **forced_dice_result**: å¼ºåˆ¶éª°å­ç»“æœ
  ```json
  {
    "type": "forced_dice_result",
    "value": [3, 3, 3, 3, 3, 3],
    "score_penalty": -5
  }
  ```

- **dice_modifier**: éª°å­ä¿®æ­£å€¼
  ```json
  {
    "type": "dice_modifier",
    "value": 1,
    "duration": 1
  }
  ```

### é“å…·ç›¸å…³

- **give_item**: ç»™äºˆæŒ‡å®šé“å…·
  ```json
  {
    "type": "give_item",
    "item": "åæ‚”åˆ¸",
    "quantity": 1
  }
  ```

- **random_item**: éšæœºé“å…·
  ```json
  {
    "type": "random_item"
  }
  ```

### Buffç›¸å…³

- **permanent_buff**: æ°¸ä¹…å¢ç›Š
  ```json
  {
    "type": "permanent_buff",
    "buff": "dice_cost_reduction",
    "value": 1
  }
  ```

- **reroll_buff**: é‡æŠ•buff
  ```json
  {
    "type": "reroll_buff",
    "duration": 3,
    "per_turn_limit": 1
  }
  ```

### å›åˆæ§åˆ¶

- **skip_turn**: è·³è¿‡å›åˆ
  ```json
  {
    "type": "skip_turn",
    "cost_score": true
  }
  ```

- **void_turn**: ä½œåºŸæœ¬å›åˆ
  ```json
  {
    "type": "void_turn"
  }
  ```

### åˆ¤å®šç›¸å…³

- **dice_check**: éª°å­åˆ¤å®š
  ```json
  {
    "type": "dice_check",
    "dice": "1d20",
    "success_threshold": 11,
    "success_effect": { "type": "score_change", "value": 20 },
    "fail_effect": { "type": "score_change", "value": -10 }
  }
  ```

## æ·»åŠ æ–°é­é‡

### 1. ç¼–è¾‘é…ç½®æ–‡ä»¶

åœ¨ `config/encounters.json` ä¸­æ·»åŠ æ–°é­é‡ï¼š

```json
{
  "encounters": {
    "ä½ çš„é­é‡åç§°": {
      "id": 41,
      "name": "ä½ çš„é­é‡åç§°",
      "description": "é­é‡æè¿°æ–‡æœ¬",
      "quote": "è§’è‰²å°è¯ï¼ˆå¯é€‰ï¼‰",
      "choices": [
        {
          "name": "é€‰é¡¹1",
          "type": "normal",
          "effect": "score_change",
          "message": "é€‰æ‹©åæ˜¾ç¤ºçš„æ¶ˆæ¯",
          "game_effect": {
            "type": "score_change",
            "value": 10
          }
        },
        {
          "name": "é€‰é¡¹2",
          "type": "peaceful",
          "effect": "nothing",
          "message": "æ— äº‹å‘ç”Ÿã€‚"
        }
      ]
    }
  }
}
```

### 2. æ³¨å†Œæ¶ˆæ¯å¤„ç†å™¨

åœ¨ `src/services/message_processor.py` çš„ `_init_handlers` æ–¹æ³•ä¸­æ·»åŠ ï¼š

```python
self.command_handlers.update({
    "é€‰é¡¹1": self._handle_encounter_choice,
    "é€‰é¡¹2": self._handle_encounter_choice,
})
```

### 3. é…ç½®é­é‡è§¦å‘

åœ¨ `src/core/game_engine.py` çš„ `_init_map_events` æ–¹æ³•ä¸­æ·»åŠ å›ºå®šé­é‡ï¼š

```python
fixed_events = [
    {
        "column": 10,
        "position": 5,
        "type": EventType.ENCOUNTER,
        "name": "ä½ çš„é­é‡åç§°"
    },
]
```

æˆ–ä½¿ç”¨éšæœºè§¦å‘æœºåˆ¶ï¼ˆå¾…å®ç°ï¼‰ã€‚

## ä½¿ç”¨ç¤ºä¾‹

### æ¸¸æˆæµç¨‹

1. **ç©å®¶ç§»åŠ¨æ£‹å­** â†’ è§¦å‘é­é‡
2. **æ˜¾ç¤ºé­é‡æè¿°å’Œé€‰é¡¹**
3. **ç©å®¶è¾“å…¥é€‰é¡¹åç§°**ï¼ˆå¦‚ï¼š"å“æ­»æˆ‘äº†"ï¼‰
4. **ç³»ç»Ÿå¤„ç†æ•ˆæœ**
5. **å¦‚æœ‰follow_upï¼Œç­‰å¾…åç»­è§¦å‘**

### QQ Botç¤ºä¾‹

```
[ç©å®¶] æ·éª°
[Bot] éª°å­ç»“æœï¼š[2, 3, 4, 5, 5, 6]
      å¯é€‰ç»„åˆï¼š...

[ç©å®¶] 7 8
[Bot] å·²ç§»åŠ¨åˆ°åˆ—7å’Œåˆ—8

      ğŸ­ é­é‡ï¼šå–µ
      ğŸ“– å–µçªç„¶ä»çŒæœ¨ä¸­çªœäº†å‡ºæ¥ã€‚

      ğŸ¯ è¯·é€‰æ‹©ä½ çš„è¡ŒåŠ¨ï¼š
      1. å“æ­»æˆ‘äº†
      2. æ‘¸æ‘¸çŒ«
      3. é™é™çœ‹å®ƒèµ°è¿‡å»

      ğŸ’¡ è¯·è¾“å…¥é€‰é¡¹åç§°

[ç©å®¶] æ‘¸æ‘¸çŒ«
[Bot] âœ¨ å–µå‘¼å™œå‘¼å™œçš„ï¼Œé åœ¨ä½ è„šè¾¹è¹­è¹­ï¼Œä¼¼ä¹å¾ˆäº«å—ã€‚
      è§£é”æŒ‡ä»¤ï¼šæ‘¸æ‘¸å–µã€æŠ•å–‚å–µï¼ˆæ¯å¤©é™5æ¬¡ï¼‰

      ğŸ”“ è§£é”æ–°æŒ‡ä»¤ï¼šæ‘¸æ‘¸å–µã€æŠ•å–‚å–µï¼ˆæ¯å¤©é™5æ¬¡ï¼‰
```

## è°ƒè¯•å’Œæµ‹è¯•

### æŸ¥çœ‹é­é‡çŠ¶æ€

```python
from src.core.encounter_system import get_encounter_manager

mgr = get_encounter_manager()
active = mgr.get_active_encounter("player_id")
print(f"å½“å‰é­é‡ï¼š{active.encounter_name if active else 'æ— '}")
```

### æŸ¥çœ‹ç©å®¶Buff

```python
from src.core.effect_handler import get_effect_handler

handler = get_effect_handler()
buffs = handler.get_active_buffs("player_id")
for buff in buffs:
    print(f"{buff.buff_type}: {buff.description} (å‰©ä½™{buff.remaining_turns}å›åˆ)")
```

### æŸ¥çœ‹å»¶è¿Ÿæ•ˆæœ

```python
from src.core.effect_handler import get_effect_handler

handler = get_effect_handler()
effects = handler.get_delayed_effects_for_turn("player_id", turn_number)
for effect in effects:
    print(f"{effect.effect_type}: {effect.description}")
```

## å¸¸è§é—®é¢˜

### Q: é­é‡ä¸è§¦å‘ï¼Ÿ

A: æ£€æŸ¥ä»¥ä¸‹å‡ ç‚¹ï¼š
1. æ•°æ®åº“è¿ç§»æ˜¯å¦è¿è¡ŒæˆåŠŸ
2. `config/encounters.json` æ–‡ä»¶æ˜¯å¦æ­£ç¡®åŠ è½½
3. é­é‡è§¦å‘ä½ç½®æ˜¯å¦æ­£ç¡®é…ç½®
4. æ£€æŸ¥game_engineæ—¥å¿—

### Q: æ•ˆæœä¸ç”Ÿæ•ˆï¼Ÿ

A: ç¡®è®¤ï¼š
1. effect_handleræ˜¯å¦æ­£ç¡®é›†æˆ
2. æ•ˆæœç±»å‹æ˜¯å¦åœ¨effect_handlerä¸­å®ç°
3. æ£€æŸ¥game_serviceä¸­çš„_execute_encounter_effectæ–¹æ³•

### Q: å¦‚ä½•æ¸…é™¤ç©å®¶çš„é­é‡çŠ¶æ€ï¼Ÿ

A: ä½¿ç”¨é­é‡ç®¡ç†å™¨ï¼š
```python
from src.core.encounter_system import get_encounter_manager
mgr = get_encounter_manager()
mgr.clear_encounter("player_id")
```

## æœ€ä½³å®è·µ

1. **æµ‹è¯•æ–°é­é‡**ï¼šåœ¨æ·»åŠ åˆ°ç”Ÿäº§ç¯å¢ƒå‰ï¼Œå…ˆåœ¨CLIæ¨¡å¼ä¸‹æµ‹è¯•
2. **æ•ˆæœå¹³è¡¡**ï¼šé¿å…æ•ˆæœè¿‡äºå¼ºå¤§æˆ–è¿‡äºæƒ©ç½š
3. **æç¤ºæ¸…æ™°**ï¼šç¡®ä¿é€‰é¡¹å’Œæ•ˆæœæè¿°æ¸…æ™°æ˜“æ‡‚
4. **é”™è¯¯å¤„ç†**ï¼šä¸ºå¼‚å¸¸æƒ…å†µæä¾›å‹å¥½çš„é”™è¯¯æ¶ˆæ¯
5. **æ•°æ®å¤‡ä»½**ï¼šåœ¨è¿è¡Œè¿ç§»å‰å¤‡ä»½æ•°æ®åº“

## æ‰©å±•å¼€å‘

### æ·»åŠ æ–°æ•ˆæœç±»å‹

1. åœ¨ `src/core/effect_handler.py` çš„ `EffectType` æšä¸¾ä¸­æ·»åŠ 
2. åœ¨ `apply_effect` æ–¹æ³•ä¸­æ·»åŠ å¤„ç†é€»è¾‘
3. å®ç°å¯¹åº”çš„ `_apply_xxx` æ–¹æ³•

### è‡ªå®šä¹‰é­é‡è§¦å‘æœºåˆ¶

å¯ä»¥åœ¨ `game_engine.py` ä¸­è‡ªå®šä¹‰è§¦å‘é€»è¾‘ï¼š
- åŸºäºæ¦‚ç‡è§¦å‘
- åŸºäºç©å®¶çŠ¶æ€è§¦å‘
- åŸºäºæ—¶é—´/äº‹ä»¶è§¦å‘

## æ”¯æŒ

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·å‚è€ƒï¼š
- CLAUDE.md - é¡¹ç›®æ•´ä½“è¯´æ˜
- æºä»£ç æ³¨é‡Š
- æäº¤Issueåˆ°é¡¹ç›®ä»“åº“
