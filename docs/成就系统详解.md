# 成就系统详解

## 系统概述

Can't Stop游戏拥有一个完整的成就系统，玩家可以通过完成特定条件解锁成就并获得奖励。

---

## 📊 成就系统架构

### 核心组件

1. **基础成就系统** (`src/core/achievement_system.py`)
   - 定义成就数据结构
   - 管理成就解锁状态

2. **增强成就系统** (`src/core/enhanced_achievement_system.py`)
   - 支持配置文件驱动
   - 自动事件检测
   - 向后兼容基础系统

3. **成就管理器** (`src/core/achievement_manager.py`)
   - 统一接口
   - 自动选择系统版本

4. **配置文件** (`config/achievements.json`)
   - 定义所有成就
   - 配置解锁条件
   - 设置奖励

---

## 🏆 成就列表

### 倒霉类成就 (UNLUCKY)

#### 1. 🏠 领地意识
- **描述**：回家吧孩子回家吧！恭喜？您已在当前列回家三次，太倒霉啦！
- **解锁条件**：在同一列失败并回到起点3次
- **奖励**：修改液 - 下一次掷骰可以将结果直接改变成上一轮行进竖列的任意两个数字

#### 2. 📅 出门没看黄历
- **描述**：人总不能一直倒霉吧！恭喜？您已遭遇三次首达陷阱，太倒霉啦！
- **解锁条件**：首次触发陷阱3次
- **奖励**：风水罗盘 - 下一次掷骰可以将任意一个数值的临时标记移动两格

#### 3. 🎯 自巡航
- **描述**：自巡航导弹但是是自己的自！恭喜？您在使用道具的时候触发陷阱/自己触发惩罚
- **解锁条件**：使用道具时触发陷阱或自己触发惩罚
- **奖励**：婴儿般的睡眠 - 下一回合免费

---

### 挑战类成就 (CHALLENGE)

#### 4. ⚡ 看我一命通关！
- **描述**：真正的赌狗无惧挑战！恭喜您在一轮次内从起点到达列终点
- **解锁条件**：在单个回合内从0走到列顶（完成一整列）
- **奖励**：奇妙的变身器 - 特殊道具，具体效果待解锁后发现

#### 5. 🎭 平平淡淡才是真
- **描述**：啊？还有这事？恭喜您在遭遇中三次选择结果均无事发生
- **解锁条件**：连续3次在遭遇中选择和平选项（结果无事发生）
- **奖励**：老头款大背心 - 纪念品道具

#### 6. 🎲 善恶有报
- **描述**：怪我吗？恭喜您在遭遇中三次选择结果均触发特殊效果
- **解锁条件**：连续3次在遭遇中选择特殊效果选项
- **奖励**：游戏机打折券 - 商店相关优惠道具

---

### 收集类成就 (COLLECTION)

#### 7. 📦 收集癖
- **描述**：不拿全浑身难受啊！恭喜您解锁全部地图及道具
- **解锁条件**：收集所有道具和探索所有地图区域
- **奖励**：协会的赞助奖金 - 大量积分奖励

---

### 特殊类成就 (SPECIAL)

#### 8. 🔥 火球术大师
- **描述**：体验魔法的不稳定性
- **解锁条件**：触发"小小火球术"陷阱
- **奖励**：火球术经验 - 特殊称号

#### 9. 🐈 好奇心害死猫
- **描述**：有些真相不该被知道
- **解锁条件**：触发"不要回头"陷阱
- **奖励**：神秘经验 - 特殊称号

#### 10. 🎊 吉祥三宝
- **描述**：★✦恭喜您第三次通关游戏✦★
- **解锁条件**：第3次完成游戏（精确匹配）
- **奖励类型**：混合奖励
  - 游戏内：积分+50
  - 现实奖励：丑喵团子一只 纪念币一枚（私信官号领取，不包邮）

#### 11. 🎯 一步之遥
- **描述**：掌声通过隐藏音响传来，全息投影跳出"恭喜通关"的电子贺卡……★✦恭喜您第四次通关游戏✦★
- **解锁条件**：第4次完成游戏（精确匹配）
- **奖励**：无

#### 12. 🐔 鹤立OAS群
- **描述**：大吉大利，今晚吃鸡！肥美的烤鸡扑扇着翅膀飞到了你面前的盘子里，诱人的香气让你迫不及待地切开金黄外皮…不对，等一下？！
- **解锁条件**：首次完成任意一列
- **奖励类型**：混合奖励
  - 游戏内：积分+20
  - 现实奖励：纪念币一枚（私信官号领取，不包邮）

### 隐藏成就

隐藏成就在未解锁前不会显示在成就列表中，只有解锁后才会揭示。

#### 13. ❄️ 雪中送炭 *[隐藏]*
- **描述**：惩罚了吗？哎↗ 没有～
- **解锁条件**：在遭遇陷阱后触发奖励/规避规则书惩罚·负面影响
- **奖励**：欧皇王冠 - 隐藏道具

#### 14. 🔮 天机算不尽 *[隐藏]*
- **描述**：是劫还是缘
- **解锁条件**：已解锁3个隐藏成就
- **奖励**：套娃 - 隐藏道具

#### 15. ⚠️ 主持人的猜忌 *[隐藏]*
- **描述**：恭喜您2次在遭遇陷阱后触发奖励/规避规则书惩罚·负面影响
- **解锁条件**：2次规避陷阱惩罚
- **奖励**：黄牌警告 - 隐藏道具

---

## 📋 成就解锁条件类型

### 1. event_count（事件计数）
累计触发指定事件达到一定次数

```json
{
  "type": "event_count",
  "event": "player_died",
  "count": 3,
  "scope": "lifetime"
}
```

### 2. trap_triggered（陷阱触发）
触发特定陷阱

```json
{
  "type": "trap_triggered",
  "trap_name": "小小火球术"
}
```

### 3. single_turn_complete（单回合完成）
在一个回合内完成特定任务

```json
{
  "type": "single_turn_complete",
  "description": "在一轮次内从起点到达列终点"
}
```

### 4. consecutive_peaceful_choices（连续和平选择）
连续多次选择和平选项

```json
{
  "type": "consecutive_peaceful_choices",
  "count": 3
}
```

### 5. consecutive_special_effects（连续特殊效果）
连续多次触发特殊效果

```json
{
  "type": "consecutive_special_effects",
  "count": 3
}
```

### 6. collection_complete（收集完成）
完成特定收集目标

```json
{
  "type": "collection_complete",
  "items_required": ["all_items", "all_maps"]
}
```

### 7. complex（复杂条件）
需要自定义检查函数

```json
{
  "type": "complex",
  "description": "使用道具时触发陷阱/自己触发惩罚",
  "check_function": "check_self_cruise"
}
```

### 8. game_complete_count（游戏完成次数）
追踪玩家完成游戏的次数

```json
{
  "type": "game_complete_count",
  "count": 3,
  "exact": true
}
```
- `count`: 需要完成的次数
- `exact`: 是否精确匹配（true=恰好该次数，false=至少该次数）

### 9. first_complete_column（首次完成列）
检测玩家首次完成任意列

```json
{
  "type": "first_complete_column",
  "description": "首次完成任意一列"
}
```

### 10. avoid_trap_penalty（规避陷阱惩罚）
检测玩家在触发陷阱后立即获得奖励或规避负面影响

```json
{
  "type": "avoid_trap_penalty",
  "description": "在遭遇陷阱后触发奖励或规避负面影响"
}
```

### 11. hidden_achievements_count（隐藏成就数量）
统计玩家已解锁的隐藏成就数量

```json
{
  "type": "hidden_achievements_count",
  "count": 3
}
```

### 12. avoid_trap_penalty_count（多次规避陷阱）
累计规避陷阱惩罚的次数

```json
{
  "type": "avoid_trap_penalty_count",
  "count": 2
}
```

---

## 🎁 成就奖励类型

### 道具奖励（reward_type: "item"）
- **修改液**：可以修改骰子结果
- **风水罗盘**：可以额外移动标记
- **婴儿般的睡眠**：免费回合
- **奇妙的变身器**：特殊道具
- **老头款大背心**：纪念品
- **游戏机打折券**：商店折扣
- **欧皇王冠**：隐藏道具
- **套娃**：隐藏道具
- **黄牌警告**：隐藏道具

### 积分奖励（reward_type: "score"）
- **协会的赞助奖金**：大量积分

### 称号奖励（reward_type: "title"）
- **火球术经验**：特殊称号
- **神秘经验**：特殊称号

### 混合奖励（reward_type: "mixed"）
同时获得游戏内奖励和现实奖励：

```json
{
  "reward_type": "mixed",
  "reward_data": {
    "score": 50,
    "real_world": "丑喵团子一只 纪念币一枚（私信官号领取，不包邮）"
  }
}
```

- **游戏内**：积分、道具等
- **现实奖励**：实物奖品（需联系官方领取）

示例：
- **吉祥三宝**：积分+50 + 丑喵团子 + 纪念币
- **鹤立OAS群**：积分+20 + 纪念币

### 无奖励（reward_type: "none"）
某些成就本身就是荣誉，不提供实质奖励

示例：
- **一步之遥**：第4次通关的纯粹荣誉

---

## 💻 系统实现

### 检查成就解锁状态

```python
from src.core.achievement_manager import AchievementManager

manager = AchievementManager()

# 获取所有成就
all_achievements = manager.get_all_achievements()

# 获取已解锁成就
unlocked = manager.get_unlocked_achievements()

# 获取未解锁成就
locked = manager.get_locked_achievements()

# 检查特定成就
is_unlocked = manager.check_achievement_unlocked("fire_master")
```

### 手动解锁成就

```python
from datetime import datetime

manager = AchievementManager()

# 解锁成就
success = manager.unlock_achievement(
    "fire_master",
    datetime.now().isoformat()
)
```

### 按分类查询

```python
from src.core.achievement_system import AchievementCategory

manager = AchievementManager()

# 获取挑战类成就
challenge_achievements = manager.get_achievement_by_category(
    AchievementCategory.CHALLENGE
)
```

---

## 🔧 添加新成就

### 1. 编辑配置文件

在 `config/achievements.json` 添加新成就：

```json
{
  "achievements": {
    "your_achievement_id": {
      "name": "🎯 你的成就名称",
      "description": "成就描述文本",
      "category": "CHALLENGE",
      "reward_description": "奖励描述",
      "conditions": [
        {
          "type": "event_count",
          "event": "your_event",
          "count": 5,
          "scope": "lifetime"
        }
      ]
    }
  }
}
```

### 2. 重启系统

增强成就系统会自动加载新配置的成就。

### 3. 触发事件

确保游戏中会发出对应的事件：

```python
from src.core.event_system import emit_game_event, GameEventType

emit_game_event(
    GameEventType.CUSTOM,
    player_id,
    {"event": "your_event"},
    session_id
)
```

---

## 🎮 游戏中如何获得成就

### 自动解锁
大部分成就会在满足条件时自动解锁，玩家会收到通知。

### 遭遇相关成就
通过在遭遇中做出特定选择来解锁：

```
示例：平平淡淡才是真

[遭遇1] → 选择和平选项 → 无事发生
[遭遇2] → 选择和平选项 → 无事发生
[遭遇3] → 选择和平选项 → 无事发生
→ 🎉 解锁成就：平平淡淡才是真
```

### 陷阱相关成就
触发特定陷阱自动解锁：

```
触发"小小火球术" → 🎉 解锁成就：火球术大师
```

### 挑战相关成就
完成特定挑战：

```
在一个回合内完成整列 → 🎉 解锁成就：看我一命通关！
```

---

## 📊 成就进度追踪

系统会自动追踪玩家的成就进度：

- **事件计数**：自动累计
- **连续选择**：自动记录
- **收集进度**：实时更新

### 查看进度

```python
manager = AchievementManager()
progress = manager.get_player_progress(player_id)

print(f"已解锁: {progress['unlocked_count']}/{progress['total_count']}")
print(f"完成度: {progress['completion_percentage']:.1f}%")
```

### 查看可见成就（排除隐藏成就）

```python
from src.core.enhanced_achievement_system import EnhancedAchievementSystem

system = EnhancedAchievementSystem()

# 获取可见成就（排除未解锁的隐藏成就）
visible_achievements = system.get_visible_achievements()

for achievement in visible_achievements:
    status = "✅" if achievement.is_unlocked else "❌"
    print(f"{status} {achievement.name}")
```

### 解锁成就并处理奖励

```python
from src.core.enhanced_achievement_system import EnhancedAchievementSystem
from datetime import datetime

system = EnhancedAchievementSystem()

# 解锁成就并自动处理奖励
result = system.unlock_achievement_with_reward(
    "lucky_three",
    "player_id",
    datetime.now().isoformat()
)

if result["success"]:
    print(f"🎉 成就解锁: {result['achievement'].name}")
    for msg in result["reward_result"]["messages"]:
        print(f"   {msg}")

    if result["reward_result"].get("has_real_world_reward"):
        print("   📧 请联系官方领取现实奖励！")
```

---

## 🔍 调试和测试

### 查看所有成就

```python
from src.core.achievement_manager import AchievementManager

manager = AchievementManager()
achievements = manager.get_all_achievements()

for achievement in achievements:
    status = "✅" if achievement.is_unlocked else "❌"
    print(f"{status} {achievement.name}")
    print(f"   {achievement.description}")
    print(f"   条件: {achievement.unlock_condition}")
    print(f"   奖励: {achievement.reward_description}")
    print()
```

### 测试成就解锁

```python
# 手动触发事件测试
from src.core.event_system import emit_game_event, GameEventType

# 触发玩家死亡事件
for i in range(3):
    emit_game_event(
        GameEventType.PLAYER_DIED,
        "test_player",
        {},
        "test_session"
    )

# 检查是否解锁"领地意识"成就
manager = AchievementManager()
is_unlocked = manager.check_achievement_unlocked("territory_awareness")
print(f"领地意识已解锁: {is_unlocked}")
```

---

## 📈 成就统计

### 玩家成就概览

```python
def show_player_achievements(player_id: str):
    manager = AchievementManager()

    unlocked = manager.get_unlocked_achievements()
    locked = manager.get_locked_achievements()

    print(f"🏆 成就统计")
    print(f"已解锁: {len(unlocked)}")
    print(f"未解锁: {len(locked)}")
    print(f"总计: {len(unlocked) + len(locked)}")
    print(f"完成度: {len(unlocked) / (len(unlocked) + len(locked)) * 100:.1f}%")

    print(f"\n✅ 已解锁成就：")
    for ach in unlocked:
        print(f"  {ach.name}")

    print(f"\n❌ 未解锁成就：")
    for ach in locked:
        print(f"  {ach.name} - {ach.unlock_condition}")
```

---

## 🎯 最佳实践

### 1. 成就设计原则
- **可达成**：条件不要过于苛刻
- **有趣味**：让玩家想要挑战
- **有奖励**：给予实际游戏优势
- **分类清晰**：便于玩家查找

### 2. 奖励平衡
- **倒霉类**：补偿性奖励（帮助扭转局势）
- **挑战类**：强力奖励（鼓励高难度挑战）
- **收集类**：大量积分或稀有道具
- **特殊类**：纪念性或称号

### 3. 条件设置
- 避免过于简单（失去挑战性）
- 避免过于困难（打击玩家积极性）
- 提供进度反馈（让玩家知道距离目标还有多远）

---

## 🔮 未来扩展

### 计划中的成就

1. **连击大师**：连续10次成功移动标记
2. **幸运儿**：在骰子判定中连续5次成功
3. **探险家**：触发所有遭遇事件
4. **道具收藏家**：收集所有道具
5. **社交达人**：与10个不同玩家互动

### 系统增强

1. **成就链**：解锁某些成就后才能解锁更高级成就
2. **隐藏成就**：不显示解锁条件的神秘成就
3. **时限成就**：限时活动成就
4. **多人成就**：需要多个玩家合作完成

---

## 📚 相关文档

- **CLAUDE.md** - 项目整体说明
- **遭遇系统使用指南.md** - 遭遇系统详解
- **陷阱与成就系统详解.md** - 陷阱系统说明

---

## 💡 常见问题

### Q: 成就解锁后奖励如何领取？

A: 成就解锁后，奖励道具会自动添加到玩家库存中，可以通过"查看库存"指令查看。

### Q: 成就可以重复解锁吗？

A: 不可以。每个成就只能解锁一次。

### Q: 如何查看成就进度？

A: 使用"成就列表"或"我的成就"指令查看所有成就及解锁状态。

### Q: 可以自定义成就吗？

A: 可以！编辑 `config/achievements.json` 添加自定义成就，系统会自动加载。

### Q: 什么是隐藏成就？如何查看？

A: 隐藏成就在未解锁前不会在成就列表中显示，只有解锁后才会揭示。在配置文件中设置 `"is_hidden": true` 即可将成就设为隐藏。使用 `get_visible_achievements()` 方法获取的列表会自动排除未解锁的隐藏成就。

### Q: 混合奖励中的现实奖励如何领取？

A: 当解锁带有现实奖励的成就时，系统会显示提示信息。玩家需要私信官方账号提供成就截图和收货信息来领取实物奖品。注意：现实奖励不包邮。

### Q: 如何追踪游戏完成次数？

A: 游戏完成次数保存在数据库的 `players.games_won` 字段中。每次完成游戏时会自动更新。成就系统会监听 `GAME_COMPLETED` 事件并检查完成次数。

---

**成就系统让游戏更有深度和可玩性！开始你的成就收集之旅吧！** 🏆✨
